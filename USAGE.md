# TTY Debug 工具使用说明

## 脚本功能

`test.sh` 是一个用于监控指定用户ID的所有进程接收信号34(SIGRTMIN+0)和35(SIGRTMIN+1)的脚本。

## 使用方法

### 基本用法
```bash
sudo ./test.sh <uid>
```

### 优先监控特定进程
```bash
sudo ./test.sh <uid> <priority_pid>
```

## 参数说明

- `<uid>`: 要监控的用户ID（必需）
- `<priority_pid>`: 优先监控的进程ID（可选）

## 示例

### 监控UID 1000的所有进程
```bash
sudo ./test.sh 1000
```

### 优先监控特定进程
```bash
sudo ./test.sh 1000 12345
```

## 输出说明

脚本会输出以下信息：
- ✔️ 成功附加到进程的提示
- ⚠️ 错误或警告信息
- 🔍 扫描进程的统计信息
- 信号检测结果，格式为：`[时间] SIGRTMIN+0 (signal 34) delivered to PID xxxx`

## 工作原理

1. **进程发现**：扫描系统中属于指定UID的所有进程
2. **优先级排序**：
   - 如果指定了priority_pid，该进程会被优先监控
   - 其他进程按PID倒序排列（较新的进程优先）
3. **并发监控**：最多同时监控20个进程以保证性能
4. **实时检测**：使用strace实时监控每个进程接收的信号

## 性能优化

- 限制同时监控进程数为20个，避免系统负载过高
- 按PID倒序优先监控较新的进程
- 自动清理已退出进程的监控
- 每3秒重新扫描进程列表

## 注意事项

1. 需要root权限运行（使用sudo）
2. 信号34对应SIGRTMIN+0，在strace中显示为SIGRT_2
3. 信号35对应SIGRTMIN+1，在strace中显示为SIGRT_3
4. 按Ctrl+C停止监控

## 修复说明

**问题**：原始脚本无法检测到信号34和35

**原因**：
1. 信号格式匹配错误：strace显示的是`SIGRT_2`/`SIGRT_3`而不是`SIG34`/`SIG35`
2. 进程监控顺序：大量进程时，测试进程可能不在前20个监控范围内

**解决方案**：
1. 修正了信号检测模式，使用正确的`SIGRT_2`和`SIGRT_3`格式
2. 添加了优先PID参数，确保重要进程被优先监控
3. 优化了进程排序，按PID倒序优先监控较新的进程
4. 改进了错误处理和性能优化

## 测试工具

项目还包含以下测试工具：

- `test_signal_receiver.sh`: 用于接收信号的测试程序
- `test_targeted.sh`: 监控单个特定PID的简化版脚本
